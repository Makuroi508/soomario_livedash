<script>
    // CONFIGURATION - Google Apps Script endpoint returning JSON
    const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwsZ-3-FbGlwIwZaXGpesRZbK0LrxsUEps3e1syVJdJK37LstfYXuIyubBLt_69P9ho/exec';
    
    let allBotsData = {};
    let selectedBots = new Set();
    let investments = {};
    let currentLeverage = 1;
    let allCharts = [];

    // Bot colors matching Soomario theme
    const botColors = {
        'CRV_OKX': '#d4a574',
        'HYPE_OKX': '#f4d291',
        'LINK_PIONEX': '#c9973d',
        'LTC_PIONEX': '#e8d7c3',
        'PUMPFUN_PIONEX': '#b8a08d'
    };

    // Set leverage (1x or 2x)
    function setLeverage(leverage) {
        currentLeverage = leverage;
        
        // Update button states
        document.querySelectorAll('.leverage-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Show/hide warning
        const warning = document.getElementById('leverageWarning');
        if (leverage > 1) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
        
        // Update dashboard
        if (Object.keys(allBotsData).length > 0) {
            updateDashboard();
        }
    }

    // Load data from Google Sheets
    async function loadData() {
        try {
            const response = await fetch(GOOGLE_SHEET_URL);
            if (!response.ok) throw new Error('Failed to fetch data');
            const data = await response.json();
            allBotsData = data;
            initializeBotSelector();
            updateDashboard();
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('metricsContainer').innerHTML = `
                <div class="error">
                    <h3>⚠️ Error Loading Data</h3>
                    <p>Please check your Google Sheets URL configuration.</p>
                    <p>Error: ${error.message}</p>
                </div>
            `;
        }
    }

    // Initialize bot selector checkboxes
    function initializeBotSelector() {
        const botGrid = document.getElementById('botGrid');
        botGrid.innerHTML = '';

        Object.keys(allBotsData).forEach(botName => {
            const botDiv = document.createElement('div');
            botDiv.className = 'bot-option';
            botDiv.innerHTML = `
                <label>
                    <input type="checkbox" value="${botName}" onchange="toggleBot('${botName}')" checked>
                    <span>${botName}</span>
                </label>
                <input type="number" 
                       id="investment-${botName}" 
                       placeholder="Initial investment ($)" 
                       value="10000"
                       min="0"
                       step="100">
            `;
            botGrid.appendChild(botDiv);
            
            // Initialize as selected
            selectedBots.add(botName);
            investments[botName] = 10000;
        });
    }

    // Toggle bot selection
    function toggleBot(botName) {
        if (selectedBots.has(botName)) {
            selectedBots.delete(botName);
        } else {
            selectedBots.add(botName);
        }
    }

    // Update investments from inputs
    function updateInvestments() {
        selectedBots.forEach(botName => {
            const input = document.getElementById(`investment-${botName}`);
            if (input) {
                investments[botName] = parseFloat(input.value) || 10000;
            }
        });
    }

    // Calculate metrics for selected bots
    function calculateMetrics() {
        updateInvestments();
        
        let totalInvestment = 0;
        let totalReturn = 0;
        let totalReturnLeveraged = 0;
        let allTrades = [];
        let worstDrawdown = 0;              // in %
        let worstDrawdownLeveraged = 0;     // in %

        selectedBots.forEach(botName => {
            const botData = allBotsData[botName];
            if (!botData || botData.length === 0) return;

            const investment = investments[botName];
            totalInvestment += investment;

            // cumulative_pnl_percent from sheet is already a % (e.g. 6.86)
            const latestTrade = botData[botData.length - 1];
            const returnPercentDecimal = latestTrade.cumulative_pnl_percent / 100;  // convert to decimal
            
            const returnAmount = investment * returnPercentDecimal;
            const returnAmountLeveraged = investment * (returnPercentDecimal * currentLeverage);
            
            totalReturn += returnAmount;
            totalReturnLeveraged += returnAmountLeveraged;

            // Add trades with bot name
            botData.forEach(trade => {
                allTrades.push({
                    ...trade,
                    botName: botName,
                    investment: investment
                });
            });

            // Track worst drawdown (in %)
            botData.forEach(trade => {
                if (trade.cumulative_pnl_percent < worstDrawdown) {
                    worstDrawdown = trade.cumulative_pnl_percent;
                }
            });
        });

        // Leveraged DD is just scaled
        worstDrawdownLeveraged = worstDrawdown * currentLeverage;

        // Win rate etc
        const completedTrades = allTrades.filter(t => t.type.toLowerCase().includes('exit'));
        const profitableTrades = completedTrades.filter(t => t.net_pnl_usdt > 0);
        const winRate = completedTrades.length > 0 ? 
            (profitableTrades.length / completedTrades.length) * 100 : 0;

        const avgWin = profitableTrades.length > 0 ?
            profitableTrades.reduce((sum, t) => sum + t.net_pnl_usdt, 0) / profitableTrades.length : 0;
        
        const losingTrades = completedTrades.filter(t => t.net_pnl_usdt <= 0);
        const avgLoss = losingTrades.length > 0 ?
            losingTrades.reduce((sum, t) => sum + t.net_pnl_usdt, 0) / losingTrades.length : 0;

        return {
            totalInvestment,
            totalReturn,
            totalReturnLeveraged,
            totalValue: totalInvestment + totalReturn,
            totalValueLeveraged: totalInvestment + totalReturnLeveraged,
            roiPercent: totalInvestment > 0 ? (totalReturn / totalInvestment) * 100 : 0,
            roiPercentLeveraged: totalInvestment > 0 ? (totalReturnLeveraged / totalInvestment) * 100 : 0,
            maxDrawdown: worstDrawdown,                    // already in %
            maxDrawdownLeveraged: worstDrawdownLeveraged,  // in %
            winRate,
            totalTrades: completedTrades.length,
            profitableTrades: profitableTrades.length,
            avgWin,
            avgLoss,
            avgWinLeveraged: avgWin * currentLeverage,
            avgLossLeveraged: avgLoss * currentLeverage,
            allTrades: allTrades.sort((a, b) => new Date(a.datetime) - new Date(b.datetime))
        };
    }

    // Update dashboard display
    function updateDashboard() {
        // Destroy old charts
        allCharts.forEach(chart => chart.destroy());
        allCharts = [];

        if (selectedBots.size === 0) {
            document.getElementById('metricsContainer').innerHTML = `
                <div class="error">
                    <h3>⚠️ No Bots Selected</h3>
                    <p>Please select at least one bot to view the dashboard.</p>
                </div>
            `;
            document.getElementById('botChartsGrid').innerHTML = '';
            drawCombinedPortfolio();
            return;
        }

        const metrics = calculateMetrics();
        const leverageBadge = currentLeverage > 1 ? `<span class="leverage-badge">${currentLeverage}x</span>` : '';

        // Metrics row only
        document.getElementById('metricsContainer').innerHTML = `
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Investment</div>
                    <div class="metric-value">
                        $${metrics.totalInvestment.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                </div>
                <div class="metric-card ${currentLeverage > 1 ? 'leveraged' : ''}">
                    <div class="metric-label">Current Value ${leverageBadge}</div>
                    <div class="metric-value ${metrics.totalReturnLeveraged >= 0 ? 'positive' : 'negative'}">
                        $${metrics.totalValueLeveraged.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                    ${currentLeverage > 1 ? `<div class="metric-subvalue">Unleveraged: $${metrics.totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>` : ''}
                </div>
                <div class="metric-card ${currentLeverage > 1 ? 'leveraged' : ''}">
                    <div class="metric-label">Total Return ${leverageBadge}</div>
                    <div class="metric-value ${metrics.totalReturnLeveraged >= 0 ? 'positive' : 'negative'}">
                        $${metrics.totalReturnLeveraged.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                    ${currentLeverage > 1 ? `<div class="metric-subvalue">Unleveraged: $${metrics.totalReturn.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>` : ''}
                </div>
                <div class="metric-card ${currentLeverage > 1 ? 'leveraged' : ''}">
                    <div class="metric-label">ROI % ${leverageBadge}</div>
                    <div class="metric-value ${metrics.roiPercentLeveraged >= 0 ? 'positive' : 'negative'}">
                        ${metrics.roiPercentLeveraged.toFixed(2)}%
                    </div>
                    ${currentLeverage > 1 ? `<div class="metric-subvalue">Unleveraged: ${metrics.roiPercent.toFixed(2)}%</div>` : ''}
                </div>
                <div class="metric-card ${currentLeverage > 1 ? 'leveraged' : ''}">
                    <div class="metric-label">Max Drawdown ${leverageBadge}</div>
                    <div class="metric-value negative">
                        ${metrics.maxDrawdownLeveraged.toFixed(2)}%
                    </div>
                    ${currentLeverage > 1 ? `<div class="metric-subvalue">Unleveraged: ${metrics.maxDrawdown.toFixed(2)}%</div>` : ''}
                </div>
                <div class="metric-card">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value ${metrics.winRate >= 50 ? 'positive' : 'negative'}">
                        ${metrics.winRate.toFixed(1)}%
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-value">${metrics.totalTrades}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Profitable Trades</div>
                    <div class="metric-value positive">${metrics.profitableTrades}</div>
                </div>
                <div class="metric-card ${currentLeverage > 1 ? 'leveraged' : ''}">
                    <div class="metric-label">Avg Win ${leverageBadge}</div>
                    <div class="metric-value positive">$${metrics.avgWinLeveraged.toFixed(2)}</div>
                    ${currentLeverage > 1 ? `<div class="metric-subvalue">Unleveraged: $${metrics.avgWin.toFixed(2)}</div>` : ''}
                </div>
                <div class="metric-card ${currentLeverage > 1 ? 'leveraged' : ''}">
                    <div class="metric-label">Avg Loss ${leverageBadge}</div>
                    <div class="metric-value negative">$${metrics.avgLossLeveraged.toFixed(2)}</div>
                    ${currentLeverage > 1 ? `<div class="metric-subvalue">Unleveraged: $${metrics.avgLoss.toFixed(2)}</div>` : ''}
                </div>
            </div>
        `;

        // Draw combined portfolio chart
        drawCombinedPortfolio();

        // Draw individual bot charts
        drawIndividualBotCharts();

        // Update last update info
        document.getElementById('updateInfo').textContent = 
            `Last updated: ${new Date().toLocaleString()} | Leverage: ${currentLeverage}x`;
    }

    // Draw combined portfolio value chart
    function drawCombinedPortfolio() {
        let allDates = new Set();
        let portfolioData = {};

        selectedBots.forEach(botName => {
            const botData = allBotsData[botName];
            if (!botData || botData.length === 0) return;

            const exitTrades = botData.filter(t => t.type.toLowerCase().includes('exit'));
            exitTrades.forEach(trade => {
                const date = new Date(trade.datetime).toISOString().split('T')[0];
                allDates.add(date);
            });
        });

        const sortedDates = Array.from(allDates).sort();

        sortedDates.forEach(date => {
            let portfolioValue = 0;

            selectedBots.forEach(botName => {
                const botData = allBotsData[botName];
                if (!botData || botData.length === 0) return;

                const investment = investments[botName];
                const exitTrades = botData.filter(t => t.type.toLowerCase().includes('exit'));
                
                let cumulativeReturnPercent = 0; // in %
                for (let i = 0; i < exitTrades.length; i++) {
                    const tradeDate = new Date(exitTrades[i].datetime).toISOString().split('T')[0];
                    if (tradeDate <= date) {
                        cumulativeReturnPercent = exitTrades[i].cumulative_pnl_percent;
                    } else {
                        break;
                    }
                }

                const cumulativeReturnDecimal = (cumulativeReturnPercent / 100) * currentLeverage;
                const botValue = investment * (1 + cumulativeReturnDecimal);
                portfolioValue += botValue;
            });

            portfolioData[date] = portfolioValue;
        });

        const chartData = sortedDates.map(date => ({
            x: date,
            y: portfolioData[date]
        }));

        const ctx = document.getElementById('combinedChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Total Portfolio Value',
                    data: chartData,
                    borderColor: '#d4a574',
                    backgroundColor: 'rgba(212, 165, 116, 0.1)',
                    borderWidth: 4,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#d4a574',
                    pointBorderColor: '#f4d291',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 3,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d4a574',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(26, 20, 56, 0.9)',
                        titleColor: '#d4a574',
                        bodyColor: '#e8d7c3',
                        borderColor: '#d4a574',
                        borderWidth: 2,
                        callbacks: {
                            label: function(context) {
                                return 'Value: $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: { day: 'MMM dd' }
                        },
                        ticks: {
                            color: '#d4a574',
                            maxRotation: 45,
                            minRotation: 45,
                            font: { size: 12 }
                        },
                        grid: { color: 'rgba(212, 165, 116, 0.1)' }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: '#d4a574',
                            font: { size: 12 },
                            callback: value => '$' + value.toLocaleString()
                        },
                        grid: { color: 'rgba(212, 165, 116, 0.1)' }
                    }
                }
            }
        });

        allCharts.push(chart);
    }

    // Draw individual bot equity curves
    function drawIndividualBotCharts() {
        const gridContainer = document.getElementById('botChartsGrid');
        gridContainer.innerHTML = '';

        selectedBots.forEach(botName => {
            const botData = allBotsData[botName];
            if (!botData || botData.length === 0) return;

            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `
                <h3>⚙️ ${botName} ${currentLeverage > 1 ? `<span class="leverage-badge">${currentLeverage}x</span>` : ''}</h3>
                <canvas id="chart-${botName}"></canvas>
            `;
            gridContainer.appendChild(chartDiv);

            const exitTrades = botData.filter(t => t.type.toLowerCase().includes('exit'));
            const investment = investments[botName];

            const chartData = exitTrades.map(trade => {
                const pctDec = (trade.cumulative_pnl_percent / 100) * currentLeverage;
                const value = investment * (1 + pctDec);
                return {
                    x: trade.datetime,
                    y: value
                };
            });

            const ctx = document.getElementById(`chart-${botName}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: botName,
                        data: chartData,
                        borderColor: botColors[botName] || '#d4a574',
                        backgroundColor: (botColors[botName] || '#d4a574') + '20',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: botColors[botName] || '#d4a574',
                        pointBorderColor: '#f4d291',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#d4a574',
                                font: { size: 13, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 20, 56, 0.9)',
                            titleColor: '#d4a574',
                            bodyColor: '#e8d7c3',
                            borderColor: '#d4a574',
                            borderWidth: 2,
                            callbacks: {
                                label: context => 'Value: $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'MMM dd' } },
                            ticks: {
                                color: '#d4a574',
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 11 }
                            },
                            grid: { color: 'rgba(212, 165, 116, 0.1)' }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: '#d4a574',
                                callback: value => '$' + value.toLocaleString(),
                                font: { size: 11 }
                            },
                            grid: { color: 'rgba(212, 165, 116, 0.1)' }
                        }
                    }
                }
            });

            allCharts.push(chart);
        });
    }

    window.onload = loadData;
</script>
